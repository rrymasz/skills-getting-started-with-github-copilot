<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Mergington High School Activities</title>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <header>
      <h1>Mergington High School</h1>
      <h2>Extracurricular Activities</h2>
    </header>

    <main>
      <section id="activities-container">
        <h3>Available Activities</h3>
        <div id="activities-list">
          <!-- Activities will be loaded here -->
          <p>Loading activities...</p>
        </div>
      </section>

      <section id="signup-container">
        <h3>Sign Up for an Activity</h3>
        <form id="signup-form">
          <div class="form-group">
            <label for="email">Student Email:</label>
            <input type="email" id="email" required placeholder="your-email@mergington.edu" />
          </div>
          <div class="form-group">
            <label for="activity">Select Activity:</label>
            <select id="activity" required>
              <option value="">-- Select an activity --</option>
              <!-- Activity options will be loaded here -->
            </select>
          </div>
          <button type="submit">Sign Up</button>
        </form>
        <div id="message" class="hidden"></div>
      </section>
    </main>

    <footer>
      <p>&copy; 2023 Mergington High School</p>
    </footer>

    <!-- Zastępujemy zewnętrzny app.js wbudowanym skryptem odpowiedzialnym za renderowanie kart z uczestnikami -->
    <script>
      // Unregister a participant from an activity
      async function unregisterParticipant(activity, email) {
        try {
          const res = await fetch('/activities/' + encodeURIComponent(activity) + '/signup?email=' + encodeURIComponent(email), {
            method: 'DELETE'
          });
          const data = await res.json().catch(() => ({}));
          const message = document.getElementById('message');
          if (!res.ok) {
            message.className = 'message error';
            message.textContent = data.detail || 'Błąd przy wyrejestrowaniu.';
          } else {
            message.className = 'message success';
            message.textContent = data.message || 'Wyrejestrowano pomyślnie.';
            await loadActivities();
          }
          message.classList.remove('hidden');
          setTimeout(() => message.classList.add('hidden'), 4000);
        } catch (err) {
          const message = document.getElementById('message');
          message.className = 'message error';
          message.textContent = 'Błąd połączenia.';
          message.classList.remove('hidden');
        }
      }

      // Pobierz i wyrenderuj aktywności oraz wypełnij select
      async function loadActivities() {
        const res = await fetch('/activities');
        if (!res.ok) {
          document.getElementById('activities-list').innerHTML = '<p class="error">Nie udało się załadować aktywności.</p>';
          return;
        }
        const activities = await res.json();
        const list = document.getElementById('activities-list');
        const select = document.getElementById('activity');
        list.innerHTML = '';
        select.innerHTML = '<option value="">-- Select an activity --</option>';

        Object.entries(activities).forEach(([name, info]) => {
          // Opcja w select
          const opt = document.createElement('option');
          opt.value = name;
          opt.textContent = name;
          select.appendChild(opt);

          // Karta aktywności
          const card = document.createElement('div');
          card.className = 'activity-card';

          const title = document.createElement('h4');
          title.textContent = name;
          card.appendChild(title);

          const desc = document.createElement('p');
          desc.textContent = info.description;
          card.appendChild(desc);

          const sched = document.createElement('p');
          sched.innerHTML = '<strong>Schedule:</strong> ' + info.schedule;
          card.appendChild(sched);

          const slots = document.createElement('p');
          slots.innerHTML = '<strong>Participants:</strong> ' + info.participants.length + ' / ' + info.max_participants;
          card.appendChild(slots);

          // Sekcja uczestników (lista)
          const participantsWrap = document.createElement('div');
          participantsWrap.className = 'participants-wrap';

          const participantsTitle = document.createElement('p');
          participantsTitle.className = 'participants-title';
          participantsTitle.textContent = 'Uczestnicy:';
          participantsWrap.appendChild(participantsTitle);

          const ul = document.createElement('ul');
          ul.className = 'participants';
          if (info.participants.length === 0) {
            const li = document.createElement('li');
            li.className = 'participant-item empty';
            li.textContent = 'Brak zapisanych uczniów';
            ul.appendChild(li);
          } else {
            info.participants.forEach(email => {
              const li = document.createElement('li');
              li.className = 'participant-item';
              // mały "awatar" z inicjałami
              const avatar = document.createElement('span');
              avatar.className = 'avatar';
              const initials = email.split('@')[0].split('.').map(s => s[0] || '').slice(0,2).join('').toUpperCase();
              avatar.textContent = initials;
              li.appendChild(avatar);

              const span = document.createElement('span');
              span.className = 'participant-email';
              span.textContent = email;
              li.appendChild(span);

              const del = document.createElement('button');
              del.className = 'delete-btn';
              del.type = 'button';
              del.title = 'Wyrejestruj uczestnika';
              del.innerHTML = '✖';
              del.addEventListener('click', async (e) => {
                e.stopPropagation();
                if (confirm(`Usuń ${email} z zajęć \"${name}\"?`)) {
                  await unregisterParticipant(name, email);
                }
              });
              li.appendChild(del);

              ul.appendChild(li);
            });
          }
          participantsWrap.appendChild(ul);
          card.appendChild(participantsWrap);

          list.appendChild(card);
        });
      }

      document.addEventListener('DOMContentLoaded', () => {
        loadActivities();

        // Obsługa zapisu
        const form = document.getElementById('signup-form');
        const message = document.getElementById('message');

        form.addEventListener('submit', async (e) => {
          e.preventDefault();
          message.className = 'hidden';
          const email = document.getElementById('email').value.trim();
          const activity = document.getElementById('activity').value;
          if (!email || !activity) {
            message.className = 'message error';
            message.textContent = 'Podaj email i wybierz aktywność.';
            return;
          }

          try {
            const res = await fetch('/activities/' + encodeURIComponent(activity) + '/signup?email=' + encodeURIComponent(email), {
              method: 'POST'
            });
            const data = await res.json().catch(()=>({}));
            if (!res.ok) {
              message.className = 'message error';
              message.textContent = data.detail || 'Błąd przy zapisie.';
            } else {
              message.className = 'message success';
              message.textContent = data.message || 'Zapisano pomyślnie.';
              // odśwież listę, by pokazać zaktualizowanych uczestników
              await loadActivities();
              form.reset();
            }
          } catch (err) {
            message.className = 'message error';
            message.textContent = 'Błąd połączenia.';
          }
        });
      });
    </script>
  </body>
</html>
